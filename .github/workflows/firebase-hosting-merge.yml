# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
"on":
  push:
    branches:
      - main
      - atriumcat
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set env vars (dev)
        if: endsWith(github.ref, '/main')
        run: |
          echo "FIREBASE_PROJECT_ID=rhapsody-connect-dev" >> $GITHUB_ENV
          echo "FIREBASE_SERVICE_ACCOUNT_SECRET=FIREBASE_SERVICE_ACCOUNT_DEV" >> $GITHUB_ENV
          echo "FIREBASE_CONFIG_SECRET_PREFIX=FIREBASE_CONFIG_DEV" >> $GITHUB_ENV
      - name: Set env vars (atrium cat)
        if: endsWith(github.ref, '/atriumcat')
        run: |
          echo "FIREBASE_PROJECT_ID=rhapsody-connect-atriumcat" >> $GITHUB_ENV
          echo "FIREBASE_CONFIG_SECRET_PREFIX=FIREBASE_CONFIG_ATRIUMCAT" >> $GITHUB_ENV
          echo "FIREBASE_SERVICE_ACCOUNT_SECRET=FIREBASE_SERVICE_ACCOUNT_ATRIUMCAT" >> $GITHUB_ENV
      - name: Set UI env vars
        run: |
          echo "" >> packages/ui/.env
          echo "VITE_FIREBASE_API_KEY=${{ secrets[format('{0}_API_KEY', env.FIREBASE_CONFIG_SECRET_PREFIX)] }}" >> packages/ui/.env
          echo "VITE_FIREBASE_AUTH_DOMAIN=${{ secrets[format('{0}_AUTH_DOMAIN', env.FIREBASE_CONFIG_SECRET_PREFIX)] }}" >> packages/ui/.env
          echo "VITE_FIREBASE_PROJECT_ID=${{ secrets[format('{0}_PROJECT_ID', env.FIREBASE_CONFIG_SECRET_PREFIX)] }}" >> packages/ui/.env
          echo "VITE_FIREBASE_STORAGE_BUCKET=${{ secrets[format('{0}_STORAGE_BUCKET', env.FIREBASE_CONFIG_SECRET_PREFIX)] }}" >> packages/ui/.env
          echo "VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets[format('{0}_MESSAGING_SENDER_ID', env.FIREBASE_CONFIG_SECRET_PREFIX)] }}" >> packages/ui/.env
          echo "VITE_FIREBASE_APP_ID=${{ secrets[format('{0}_APP_ID', env.FIREBASE_CONFIG_SECRET_PREFIX)] }}" >> packages/ui/.env
          echo "VITE_FIREBASE_MEASUREMENT_ID=${{ secrets[format('{0}_MEASUREMENT_ID', env.FIREBASE_CONFIG_SECRET_PREFIX)] }}" >> packages/ui/.env
          echo "VITE_APP_CHECK_SITE_KEY=${{ secrets[format('{0}_APP_CHECK_SITE_KEY', env.FIREBASE_CONFIG_SECRET_PREFIX)] }}" >> packages/ui/.env
          cat ./packages/ui/.env
      - name: Set functions env vars
        run: |
          echo "" >> packages/functions/.env
          echo "BASE_URL=${{ secrets[format('{0}_BASE_URL', env.FIREBASE_CONFIG_SECRET_PREFIX)] }}" >> packages/functions/.env
          echo "MAIN_PHONE_NUMBER=${{ secrets[format('{0}_MAIN_PHONE_NUMBER', env.FIREBASE_CONFIG_SECRET_PREFIX)] }}" >> packages/functions/.env
          cat ./packages/functions/.env
      - run: npm ci
      - run: npm run build
      - run: npm run test
      - name: Deploy to Firebase
        uses: w9jds/firebase-action@master
        with:
          args: deploy
        env:
          FIREBASE_TOKEN: ${{ secrets[env.FIREBASE_SERVICE_ACCOUNT_SECRET] }}
          projectId: ${{ env.FIREBASE_PROJECT_ID }}
